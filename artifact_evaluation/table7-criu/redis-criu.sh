#!/bin/sh

SRCROOT=/root/

REDISSRV="redis-server"
CKPTDIR="$PWD/criuimage"
CONF="redis.linux.conf"
TMPFILE="redisinput"
# The size in MB
SIZE="$1"

if [ -z "$SIZE" ];then
	echo "No size given"
	exit
fi

pkill $REDISSRV

# Wait for the server to die.
sleep 1

setsid $REDISSRV $CONF &

# Wait for the server to spin up.
sleep 1

# We have to get it by PID, we put the server in
# a new session and $! points to setsid's PID.
REDISPID=$(pidof $REDISSRV)

# For some reason, directly piping redisgen.py breaks the pipe.
"$SRCROOT/linuxbench/redisgen.py" "$SIZE"  > "$TMPFILE"
cat "$TMPFILE" | redis-cli --pipe > /dev/null
rm "$TMPFILE"

mkdir -p $CKPTDIR
mount -t tmpfs -o size=10g tmpfs $CKPTDIR
criu dump -D $CKPTDIR --shell-job -t $REDISPID --display-stats > $TMPFILE 2> /dev/null
cat $TMPFILE
echo "(NOTE: Metadata copy time is not generated by CRIU. It is computed by factoring Data Copy time out of Total Stop time)"
cat $TMPFILE  | grep "Memory dump time" | sed "s/Memory dump time:/Data Copy\t/"
cat $TMPFILE  | grep "Frozen time" | sed "s/Frozen time:/Total Stop Time\t/"
cat $TMPFILE  | grep "Memory write time" | sed "s/Memory write time:/Write Time\t/"
umount $CKPTDIR
rm -r $CKPTDIR
